% list = {'/media/data2/mbrown/data/2012_transalc/20130626_transalc_c003_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130502_transalc_p013_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130911_transalc_c013_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130521_transalc_p013_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130603_transalc_p015_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130814_transalc_c009_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20131211_transalc_c018_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20121127_transalc_p004_edm_a/raw/data/se_epi_dw_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20121210_transalc_p006_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130627_transalc_p016_edm_a/raw/data/se_epi_dw_run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130418_transalc_p012_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130724_transalc_c005_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20131113_transalc_c015_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130731_transalc_c011_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20131023_transalc_c016_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130812_transalc_p020_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130724_transalc_c004_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130926_transalc_p023_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20121218_transalc_p004_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20120719_transalc_p001_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20131120_transalc_c018_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130430_transalc_p008_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20131023_transalc_c014_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130731_transalc_p018_edm_b/raw/data/se_epi_dw_run1_restingstate.fid', '/media/data2/mbrown/data/2012_transalc/20120820_transalc_p003_edm_a/raw/data/se_epi_dw_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130711_transalc_p018_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130718_transalc_p016_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130815_transalc_p022_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20131023_transalc_c015_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20140129_transalc_p025_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130416_transalc_p010_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20120628_transalc_p001_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130507_transalc_p010_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130627_transalc_p017_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130821_transalc_c012_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130710_transalc_c001_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130619_transalc_c002_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130619_transalc_c001_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130717_transalc_c007_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130710_transalc_c006_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130815_transalc_p021_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130821_transalc_c013_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130507_transalc_p009_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20120615_transalc_01_pt/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130911_transalc_c012_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20121210_transalc_p005_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130711_transalc_c002_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130624_transalc_p015_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20120724_transalc_p002_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20131113_transalc_c016_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130807_transalc_c008_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130509_transalc_p014_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130903_transalc_p020_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130703_transalc_c005_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20131023_transalc_c017_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20120703_transalc_p002_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130409_transalc_p008_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130521_transalc_p014_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20131113_transalc_c017_edm_b/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130703_transalc_c004_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130416_transalc_p009_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20130717_transalc_c008_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid', '/media/data2/mbrown/data/2012_transalc/20131115_transalc_p024_edm_a/raw/data/se_epi_dw__run1_restingstate_01.fid'};

list = {'/media/data2/mbrown/data/2012_transalc/20130724_transalc_c009_edm_a/raw/data/se_epi_dw_01.fid', '/media/data2/mbrown/data/2012_transalc/20140108_transalc_p025_edm_a/raw/data/se_epi_dw_01.fid'};
for i = 1:size(list,2)
	% for i = 1

	cd(list{i});
	opt = EPIopt(1);
	opt.only_first = 1; % only recon the first run/volume
	[par,img] = EPIrecon_CAB(pwd,opt);

	img = flipdim(flipdim(img,1),2);

	fidpath = list{i};
	fidpath = fidpath(14:end);
	mkdir(['/media/data/Hongfu/', fidpath]);
	cd(['/media/data/Hongfu/', fidpath]);

	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Varian scanner, assuming imaging coordinates are relative to magnet frame,
% with Euler angles of phi,psi,theta
	voxelSize = par.voxsize;
	%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	mkdir('combine');
	nii = make_nii(abs(img),voxelSize);
	save_nii(nii,'combine/mag_cmb.nii');
	nii = make_nii(angle(img),voxelSize);
	save_nii(nii,'combine/ph_cmb.nii');


	bet_thr = 0.3;
	disp('--> extract brain volume and generate mask ...');
	setenv('bet_thr',num2str(bet_thr));
	unix('bet combine/mag_cmb.nii BET -f ${bet_thr} -m -R');
	unix('gunzip -f BET.nii.gz');
	unix('gunzip -f BET_mask.nii.gz');
	nii = load_nii('BET_mask.nii');
	mask = double(nii.img);



	unph = unwrapLaplacian(angle(img), size(img), voxelSize);
	nii = make_nii(unph, voxelSize);
	save_nii(nii,'unph_lap.nii');


	% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
	% % unwrap combined phase with PRELUDE
	% disp('--> unwrap aliasing phase ...');
	% unix('prelude -a combine/mag_cmb.nii -p combine/ph_cmb.nii -u unph.nii -m BET_mask.nii -n 8');
	% unix('gunzip -f unph.nii.gz');
	% nii = load_nii('unph.nii');
	% unph = double(nii.img);
	% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



	smv_rad = 6;
	tik_reg = 0.001;
	% background field removal
	disp('--> RESHARP to remove background field ...');
	mkdir('RESHARP');
	[lph_resharp,mask_resharp] = resharp(unph,mask,voxelSize,smv_rad,tik_reg);
	lfs_resharp = -lph_resharp/(2.675e8*par.te*4.7)*1e6;
	nii = make_nii(lfs_resharp,voxelSize);
	save_nii(nii,'RESHARP/lfs_resharp.nii');

	lfs_poly = zeros(size(lfs_resharp));
	for sl = 1:size(lfs_resharp,3)
		lfs_poly(:,:,sl) = poly2d(lfs_resharp(:,:,sl),mask_resharp(:,:,sl));
	end

	nii = make_nii(lfs_poly,voxelSize);
	save_nii(nii,'RESHARP/lfs_resharp_poly.nii');

	phi = par.phi/180*pi;
	psi = par.psi/180*pi;
	theta = par.theta/180*pi;
	z_prjs = [sin(psi)*sin(theta), cos(psi)*sin(theta), cos(theta)] %image coordinate projections onto Z(main field direction)
	if ~ isequal(z_prjs,[0 0 1])
		pwd
	end

	tvdi_n = 200;
	tv_reg = 0.0001;
	disp('--> TV susceptibility inversion ...');
	sus_resharp = tvdi(lfs_poly,mask_resharp,voxelSize,tv_reg,abs(img),z_prjs,tvdi_n);
	nii = make_nii(sus_resharp.*mask_resharp,voxelSize);
	save_nii(nii,'RESHARP/sus_resharp.nii');

	nii = make_nii(flipdim(flipdim(flipdim(permute(sus_resharp.*mask_resharp,[2 1 3]),1),2),3)); % clockwise rotate the nifti 90 degree
	save_nii(nii,'RESHARP/sus_resharp_rotated.nii');
	save all
end


